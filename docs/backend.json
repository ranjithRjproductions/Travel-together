{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the system with their associated role and profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The user's role (e.g., Traveler, Guide). This determines their access and permissions.",
          "enum": ["Traveler", "Guide"]
        },
        "photoURL": {
          "type": "string",
          "description": "The URL of the user's profile photo.",
          "format": "uri"
        },
        "photoAlt": {
          "type": "string",
          "description": "The user-provided alternative text for their profile photo."
        },
        "address": {
          "type": "object",
          "description": "The user's primary address.",
          "properties": {
            "addressLine1": { "type": "string" },
            "addressLine2": { "type": "string" },
            "city": { "type": "string" },
            "state": { "type": "string" },
            "postalCode": { "type": "string" },
            "country": { "type": "string" }
          },
          "required": ["addressLine1", "city", "state", "postalCode", "country"]
        },
        "contact": {
          "type": "object",
          "description": "The user's contact information.",
          "properties": {
            "primaryPhone": { "type": "string" },
            "whatsappNumber": { "type": "string" },
            "whatsappSameAsPrimary": { "type": "boolean" }
          },
          "required": ["primaryPhone", "whatsappSameAsPrimary"]
        },
        "disability": {
          "type": "object",
          "description": "Voluntary disability disclosure for accessibility purposes.",
          "properties": {
            "mainDisability": {
              "type": "string",
              "enum": ["visually-impaired", "hard-of-hearing"]
            },
            "visionSubOption": {
              "type": "string",
              "enum": ["totally-blind", "low-vision"]
            },
            "visionPercentage": {
              "type": "number"
            },
            "hearingPercentage": {
              "type": "number"
            },
            "requiresSignLanguageGuide": {
              "type": "boolean"
            },
            "documentUrl": {
              "type": "string",
              "format": "uri"
            },
            "documentName": {
              "type": "string"
            },
            "agreedToVoluntaryDisclosure": {
              "type": "boolean"
            }
          },
          "required": [
            "mainDisability",
            "agreedToVoluntaryDisclosure"
          ]
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "role"
      ]
    },
    "GuideProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GuideProfile",
      "type": "object",
      "description": "Stores detailed, professional information specific to a user in the 'Guide' role.",
      "properties": {
        "address": {
          "type": "object",
          "description": "The guide's primary operating address.",
          "properties": {
            "addressLine1": { "type": "string" },
            "addressLine2": { "type": "string" },
            "city": { "type": "string" },
            "district": { "type": "string" },
            "state": { "type": "string" },
            "country": { "type": "string" },
            "isDefault": { "type": "boolean" },
            "addressProofUrl": { "type": "string", "format": "uri" },
            "agreedToAddressProof": { "type": "boolean" }
          },
          "required": ["addressLine1", "city", "district", "state", "country", "agreedToAddressProof"]
        },
        "contact": {
          "type": "object",
          "description": "The guide's contact information.",
          "properties": {
            "primaryPhone": { "type": "string" },
            "whatsappNumber": { "type": "string" },
            "whatsappSameAsPrimary": { "type": "boolean" }
          },
          "required": ["primaryPhone"]
        },
        "disabilityExpertise": {
          "type": "object",
          "description": "Details the guide's experience with supporting travelers with disabilities.",
          "properties": {
            "experienceType": { "type": "string", "enum": ["visually-impaired", "hearing-impaired"] },
            "visionSupport": {
              "type": "object",
              "properties": {
                "specialization": { "type": "string", "enum": ["totally-blind", "low-vision"] },
                "description": { "type": "string" }
              }
            },
            "hearingSupport": {
              "type": "object",
              "properties": {
                "knowsSignLanguage": { "type": "boolean" },
                "description": { "type": "string" }
              }
            },
            "isTrained": { "type": "boolean" },
            "agreedToDisclaimer": { "type": "boolean" }
          },
          "required": ["experienceType", "isTrained"]
        },
        "verification": {
          "type": "object",
          "description": "URLs to uploaded verification documents.",
          "properties": {
            "governmentIdUrl": { "type": "string", "format": "uri" },
            "proofDocumentUrl": { "type": "string", "format": "uri" }
          }
        },
        "onboardingState": {
          "type": "string",
          "description": "Tracks the completion status of the guide's profile.",
          "enum": ["started", "profile-complete", "verification-pending", "active"],
          "default": "started"
        }
      },
      "required": ["address", "contact", "disabilityExpertise", "onboardingState"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user data, including name, email, and role. The 'role' field is immutable after signup.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/guideProfile/{guideProfileId}",
        "definition": {
          "entityName": "GuideProfile",
          "schema": {
            "$ref": "#/backend/entities/GuideProfile"
          },
          "description": "Stores guide-specific professional details. This collection only exists for users with the 'Guide' role.",
          "params": [
            {
              "name": "userId",
              "description": "The UID of the user who is a guide."
            },
            {
              "name": "guideProfileId",
              "description": "A unique ID for the guide's profile document."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "role_admin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection used to define global administrator users.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching the Firebase Auth UID."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed to securely manage user authentication and roles for the Let's Travel Together application. It prioritizes authorization independence, clarity, and adherence to the specified constraints.\n\n**Authorization Independence:** The structure avoids hierarchical authorization dependencies by storing the user's role directly within the user document at `/users/{userId}`. This eliminates the need for `get()` calls in security rules to retrieve parent document data, simplifying rule logic and enabling atomic operations.\n\n**Clarity of Intent:** The structure clearly reflects the application's intent by using a dedicated `/users/{userId}` collection for user data. The `role` field within each user document explicitly defines the user's role, enhancing debuggability and making the authorization logic transparent.\n\n**QAPs (Rules are not Filters):** The design uses structural segregation by placing all user documents within the same `/users` collection. This allows for simple security rules that apply uniformly to all documents in the collection, preventing filtering issues. List operations can be secured based on authentication and user ID without needing to filter based on document content.\n\n**DBAC (No Custom Claims):** Roles are persisted directly in Firestore within the user documents, eliminating reliance on custom claims for authorization. This aligns with the requirement that the client never decides or stores the role as truth.\n\n**Invariants:** The design supports invariants by ensuring that the `role` field is immutable after signup. Security rules can enforce this constraint to maintain the integrity of user roles.\n\n**Folder Structure and Server Action Examples (Illustrative):**\n\n```\n/app\n  /actions\n    /auth.ts       // Server actions for signup and login\n  /components\n    /...\n  /lib\n    /firebaseAdmin.ts  // Initialize Firebase Admin SDK\n```\n\n**Example Server Action (auth.ts - Illustrative):**\n\n```typescript\n// app/actions/auth.ts\n\n'use server';\n\nimport { auth, db } from '@/lib/firebaseAdmin';\nimport { User } from '@/types'; // Define your User type\nimport { revalidatePath } from 'next/cache';\n\nexport async function signUp(name: string, email: string, password: string, role: string) {\n  try {\n    const userCredential = await auth.createUser({\n      email,\n      password,\n    });\n\n    const uid = userCredential.uid;\n\n    const user: User = {\n      id: uid,\n      name,\n      email,\n      role,\n    };\n\n    await db.collection('users').doc(uid).set(user);\n\n    revalidatePath('/login'); // Redirect after signup\n    return { success: true };\n  } catch (error: any) {\n    console.error('Signup error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n\nexport async function login(email: string, password: string) {\n    try {\n        const userCredential = await auth.getUserByEmail(email);\n        // No password validation here - firebase auth does it.\n        const uid = userCredential.uid;\n\n        const doc = await db.collection('users').doc(uid).get();\n\n        if (!doc.exists) {\n            console.error('User document not found');\n            return { success: false, error: 'User document not found' };\n        }\n\n        const userData = doc.data() as User;\n        if (!userData) {\n          return { success: false, error: 'User data missing' };\n        }\n\n        return { success: true, role: userData.role };\n    } catch (error: any) {\n        console.error('Login error:', error);\n        return { success: false, error: error.message };\n    }\n}\n```"
  }
}